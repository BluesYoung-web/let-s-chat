<template>
	<!-- 消息页面  -->
    <scroll-view :scroll-y="isScroll">
		<block :key="index" v-for="(item, index) in dataList">
			<!-- 一条消息列表 -->
			<view class="message-row"   @touchstart.capture="touchS" @touchmove="touchM" @touchend.capture="touchE" :data-index="index" :style="{right:item.right + 'upx'}" >
				<view class="friend-message" @tap="toConversation">
					<!-- 朋友头像框 -->
					<view class="message-head">
						<image src="../../../static/img/logo.png"></image>
					</view>
					<!-- 消息内容 -->
					<view class="message-body">
						<view class="message-informatin">
							<span class="message-username">{{item.username}}</span>
							<span class="message-time">{{item.time}}</span>
						</view>
						<view class="message-content one-line-ellipsis">{{item.content}}</view>
					</view>	
				</view>
				<!-- 删除对话框（左滑出现） -->
				<view class="message-delete" @tap="deleteMessage">
					删除对话
				</view>
			</view>
		</block>
	</scroll-view>    
</template>

<script>
	// 使用vuex管理登录状态
	import {mapState} from 'vuex'
	export default {
		computed: mapState(['forcedLogin', 'hasLogin', 'userName']),
		onLoad() {
			// 未登录
			if (!this.hasLogin) {
			    uni.showModal({
			        title: '未登录',
			        content: '您未登录，需要登录后才能继续',
			        /**
			         * 如果需要强制登录，不显示取消按钮
			         */
			        showCancel: !this.forcedLogin,
			        success: (res) => {
			            if (res.confirm) {
							/**
							 * 如果需要强制登录，使用reLaunch方式
							 */
			                if (this.forcedLogin) {
			                    uni.reLaunch({
			                        url: '../../common/login/login'
			                    });
			                } else {
			                    uni.navigateTo({
			                        url: '../../common/login/login'
			                    });
			                }
			            }
			        }
			    });
			}
		},
		data() {
			return {
				isScroll: true,
				delBtnWidth: 160, //删除按钮宽度
				startX:'',  //手指触碰起点坐标
				dataList:[
				{
					username:"用户昵称0",
					time:"消息接收时间",
					content:"消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容",
					right: 0
				},
				{
					username:"用户昵称1",
					time:"消息接收时间",
					content:"消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容",
					right: 0
				},
				{
					username:"用户昵称2",
					time:"消息接收时间",
					content:"消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容",
					right: 0
				},
				{
					username:"用户昵称3",
					time:"消息接收时间",
					content:"消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容消息内容",
					right: 0
				}
				]				
			}
		},
		methods: {
			//前往对话界面
			toConversation:function(){
				uni.navigateTo({
					url: '../../messageSubpackage/conversation',
					success: res => {},
					fail: () => {},
					complete: () => {}
				});
			},
			// 删除消息调试
			deleteMessage:function(){
				console.log('delete')
			},
			// 触摸开始
			touchS:function (e) {
				// console.log('S')
                var touch = e.touches[0];
                            for (var index in this.dataList) {
                                this.dataList[index].right = 0;
                            }
                            this.startX = touch.clientX;
							// console.log(this.dataList[index].right)
            },
			// 触摸移动
			touchM:function(e){
				// console.log('M')
				var touch = e.touches[0];
				            var item = this.dataList[e.currentTarget.dataset.index];
				            var disX = this.startX - touch.clientX;
				// console.log(disX)
				            if (disX >=20) {
				                    if(disX>this.delBtnWidth){
										disX = this.delBtnWidth;
									}
				                
				                this.isScroll = false;
				                this.dataList[e.currentTarget.dataset.index].right = disX;
								// console.log(this.dataList[e.currentTarget.dataset.index])
				            } else {
				                this.isScroll = true;
				                this.dataList[e.currentTarget.dataset.index].right = 0;
				            }
			},
			// 触摸结束
			touchE: function (e) {
				// console.log('E') 
				var item = this.dataList[e.currentTarget.dataset.index];
				// console.log(item.right)
				            if (item.right >= this.delBtnWidth / 2) {
				                this.isScroll = true;
				                this.dataList[e.currentTarget.dataset.index].right = this.delBtnWidth;
				            } else {
				                this.isScroll = true;
				                this.dataList[e.currentTarget.dataset.index].right = 0;
				            }
							console.log(item.right)

			}
		}
	}
</script>


<style>	
	.message-row{
		width: 100%;
		height: 150upx;
		position: relative;
		background-color: #FFFFFF;
		display: flex;
	}
	.friend-message{
		width: 100%;
		display: flex;
	}
	.message-delete{
		width: 160upx;
		height: 150upx;
		position: absolute;
		top: 0;
		right: -160upx;
		color: #FFFFFF;
		font-size: 25upx;
		background-color: #eb5757;
		display: flex;
		align-items: center;
		justify-content: center;
	}
		
	.message-head{
		width: 18%;
		display: flex;
		align-items: center;
		justify-content: flex-end;		
		padding-right: 20upx;
	}
	.message-head image{
		width: 80upx;
		height: 80upx;
		border: 1px solid #344955;
		border-radius: 50%;
	}
	.message-body{
		margin-top: 20upx;
		width: 82%;
	}
	.message-username{		
		font-size: 28upx;
		font-weight: bold;
	}
	.message-time{		
		float: right;
		margin-right: 10upx;
	    color: #939393;
		font-size: 20upx;
	}
	.message-content{
		margin-top: 10upx;
		font-size: 10px;
		width: 68%;
	}
</style>
