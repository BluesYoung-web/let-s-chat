<template>
	<!-- 登陆页面 -->
	<view class="relative" :style="fullHeight">
		<!-- 商标logo -->
		<view class="logo width-full flex flex-jc">
			<image src="../../../static/img/logo.png" mode=""></image>
		</view>
		<!-- 登录的内容 -->
		<form @submit="loginCheck">
			<view v-show="showInput" class="loginContentView flex flex-ac flex-direction-column">
				<!-- 手机号输入框 -->
				<input name="phoneVal" placeholder-class="color-ccc" type="number" class="phoneInput flex" maxlength="11" v-model="phoneVal"
				 value="" placeholder="请输入手机号" />
				<!-- 验证码输入框 -->
				<view class="width-600 height-100  mg-tp20  flex flex-jsb">
					<input name="code" placeholder-class="color-ccc" maxlength="6" class="passwordInput" type="number" placeholder="请输入验证码" />
					<!-- 获取验证码 -->
					<button class="identifying-code ft-28 color-f9aa33" :disabled="isClick" @click="getIdentifyingCode">{{time}}</button>
				</view>

				<!-- 登录按钮 -->
				<button class="loginBtn bg-344955 color-fff" form-type="submit">登录</button>
				<!-- 微信登录 -->
				<view class="register flex flex-jsb mg-tp10 color-344955 ft-32">
					<text @tap="wxlogin('weixin')" :style="{color:'#00BB04'}">微信登录</text>
				<!-- </view> -->
				<!-- 注册账号 -->
				<!-- <view class="register flex flex-je mg-tp10 color-344955 ft-32"> -->
					<text @tap="register">注册账号</text>
				</view>
			</view>
		</form>
		<!-- 底部文字 -->
		<view class="bottomTip ft-32 width-full flex flex-hc absolute">
			<text class="color-999">登录即代表阅读并同意</text>
			<text class="text-decoration-none color-f9aa33" @click="showPopup">《服务协议》</text>
		</view>

		<!-- 用户协议的弹出层 -->
		<uni-popup :show="popup" type="center" @change="popupChange">
			<view class="relative" style=" height: 1200upx;">
				<scroll-view scroll-y="true" style="height: 90%;">
					<image style="height: 3000upx;" src="../../../static/img/agreement.jpg" mode="scaleToFill"></image>
				</scroll-view>
				<view class="text-center mg-tp20">
					<uni-icons type="clear" color="#fff" size="30" @click="closePopup()" />
				</view>
			</view>
		</uni-popup>
	</view>
</template>

<script>
	import uniPopup from "@/components/uni-popup/uni-popup.vue"
	import uniIcons from '@/components/uni-icons/uni-icons.vue'
	// 管理账号信息
	import service from '../../../service.js';
	// 登录状态管理
	import {mapState, mapMutations} from 'vuex'
	export default {
		components: {
			uniPopup,
			uniIcons
		},
		data() {
			return {
				showInput: true, //是否显示输入框
				popup: false, //是否弹出协议面板
				phoneVal: '', //手机号
				isClick: false, //获取验证码按钮是否可用
				time: "获取验证码", //获取验证码或倒计时
				currtime: 60, //倒计时
				fullHeight: "", //用来获取手机屏幕大小便于底部协议底部绝对布局
			}
		},
		onLoad() {

		},
		// 挂载时动态获取手机的屏幕大小然后赋值给根元素实现动态布局
		mounted() {
			var that = this;
			uni.getSystemInfo({
				success: function(res) {
					that.fullHeight = "height:" + res.windowHeight + "px";
					console.log(that.fullHeight);
				}
			});
		},
		methods: {
			// 登录的方法
			...mapMutations(['login']),
			//注册跳转
			register: function() {
				uni.navigateTo({
					url: '../register/register',
					success: res => {},
					fail: () => {},
					complete: () => {}
				});
			},
			computed: mapState(['forcedLogin']),
			// 微信登录
			wxlogin:function(value){
				console.log('123456789');
				uni.login({
				    provider: value,
				    success: (res) => {
				        uni.getUserInfo({
				            provider: value,
				            success: (infoRes) => {
				                /**
				                 * 实际开发中，获取用户信息后，需要将信息上报至服务端。
				                 * 服务端可以用 userInfo.openId 作为用户的唯一标识新增或绑定用户信息。
				                 */
				                this.toMain(infoRes.userInfo.nickName);
				            }
				        });
				    },
				    fail: (err) => {
				        console.error('授权登录失败：' + JSON.stringify(err));
				    }
				});
			},
			toMain(userName) {
			    this.login(userName);
			    /**
			     * 强制登录时使用reLaunch方式跳转过来
			     * 返回首页也使用reLaunch方式
			     */
			    if (this.forcedLogin) {
			        uni.reLaunch({
			            url: './login',
			        });
			    } else {
			        uni.navigateBack();
			    }
			},
			//获取验证码
			getIdentifyingCode: function() {
				var that = this;
				var myreg = /^(0|86|17951)?(13[0-9]|15[012356789]|166|17[3678]|18[0-9]|14[57])[0-9]{8}$/;
				var phone = that.phoneVal;
				if (!myreg.test(phone)) {
					uni.showToast({
						icon: 'none',
						title: '请输入有效手机号！',
					})
				} else {
					uni.showLoading({
						title: '加载中'
					});
					setTimeout(function() {
						uni.hideLoading();
						// 获取验证码倒计时
						that.time = that.currtime + 's';
						that.isClick = true;
						var interval = setInterval(function() {
							that.time = --that.currtime + 's';
							if (that.currtime <= 0) {
								clearInterval(interval);
								that.time = "重新获取";
								that.currtime = 60;
								that.isClick = false;
							}
						}, 1000)
						uni.showToast({
							icon: 'none',
							title: "获取验证码成功"
						})
					}, 1000);
				}
			},

			// 登陆验证
			loginCheck(e) {
				var myreg = /^[1][3,4,5,7,8,9][0-9]{9}$/;
				var formMsg = e.detail.value; //表单提交的信息
				var phone = formMsg.phoneVal;
				// 判断手机号是否正确
				if (!myreg.test(phone)) {
					uni.showToast({
						icon: 'none',
						title: '请输入有效手机号！',
					})
				}
				// 判断验证码是否填写
				else if (formMsg.code.length != 6) {
					uni.showToast({
						icon: "none",
						title: "请输入六位数的验证码"
					})

				} else {
					// 用户账号
					const data = {
					    account: formMsg.phoneVal
					}
					// 添加账号
					service.addUser(data);
					this.login(this.account);
					uni.showToast({
					    title: '登录成功'
					});
					uni.reLaunch({
						url:"../../tabBar/message/message"
					})
				}
			},

			//---------------------------弹出层------------------------
			// 展示服务协议面板
			showPopup() {
				this.popup = true;
				setTimeout(() => {
					this.showInput = false;
				}, 200);
			},
			//配合点击空白处关闭面板的函数
			popupChange(e) {
				if (!e.show) {
					this.popup = false;

					// 防止手机端输入框的placeholder层将popup弹出层覆盖,在弹出层显示时就将输入框整体的view隐藏
					setTimeout(() => {
						this.showInput = true;
					}, 50);
				}
			},
			// 点击关闭弹出层
			closePopup(e) {
				this.popup = false;
				setTimeout(() => {
					this.showInput = true;
				}, 100);
			},
		},
		//禁止返回键
		onBackPress() {
			uni.showModal({
				title: '提示',
				content: '是否退出来聊？',
				success: function(res) {
					if (res.confirm) {
						// 退出当前应用，改方法只在App中生效  
						plus.runtime.quit();
					} else if (res.cancel) {
						console.log('用户点击取消');
					}
				}
			});
			return true
		},

		// onBackPress() {
		// 	if (this.showMask) {
		// 		this.showMask = false;
		// 		return true;
		// 	} else {
		// 		uni.showModal({
		// 			title: '提示',
		// 			content: '是否退出uni-app？',
		// 			success: function(res) {
		// 				if (res.confirm) {
		// 					// 退出当前应用，改方法只在App中生效  
		// 					plus.runtime.quit();
		// 				} else if (res.cancel) {
		// 					console.log('用户点击取消');
		// 				}
		// 			}
		// 		});
		// 		return true
		// 	}
		// },

	}
</script>

<style>
	.logo {
		padding-top: 150upx;
		padding-bottom: 100upx;
	}

	.logo image {
		width: 200upx;
		height: 200upx;
	}

	.loginContentView {}

	/* 登录整体内容的view */
	.loginContentView input {
		height: 100upx;
		border: #2C405A 1px solid;
		border-radius: 6px;
		padding-left: 20upx;
		padding-left: 60upx;
		background-repeat: no-repeat;
		background-size: 40upx 40upx;
	}

	.phoneInput {
		width: 600upx;
		background-image: url("~@/static/img/phone.png");
		background-position: 18upx 30upx;
	}

	.passwordInput {
		width: 360upx;
		background-image: url("~@/static/img/message.png");
		background-position: 14upx 30upx;
	}

	/* 验证码的view */
	.identifying-code {
		border: 1px solid #344955;
		border-radius: 6px;
		width: 210upx;
		height: 100upx;
		line-height: 100upx;
		background-color: #fff;
	}

	/* 登录按钮 */
	.loginBtn {
		width: 600upx;
		height: 100upx;
		margin-top: 100upx;
	}

	/* 注册view */
	.register {
		width: 600upx;
		height: 100upx;
	}

	/* 底部协议提示 */
	.bottomTip {
		bottom: 60upx;
	}
</style>
