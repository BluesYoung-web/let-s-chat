<!-- 编辑资料 -->
<template>
	<view class="body">
		<view class="content flex flex-direction-column">
			<view class="avatarItem" @click="openPopup">
				<text>用户头像</text>
				<view class="flex flex-vc">
					<image class="avatar" :src="avatarUrl" mode="aspectFill"></image>
					<image class="rightIcon" src="../../../static/img/arrow-right.png" mode=""></image>
				</view>
			</view>
			<view class="nameItem" @tap="toChangeName">
				<text>昵称</text>
				<view class="flex flex-ac">
					<text class="inline-block width-400 one-line-ellipsis text-right ">{{name}}</text>
					<image class="rightIcon" src="../../../static/img/arrow-right.png" mode=""></image>
				</view>
			</view>
			<view class="accountItem" @longpress="accountCopy">
				<text>来聊账号</text>
				<text>{{account}}</text>
			</view>
			<view class="mottoItem" @tap="toChangeMotto">
				<text>个性签名</text>
				<view class="flex flex-ac">
					<text class="inline-block width-400 one-line-ellipsis text-right " v-model="motto"></text>
					<image class="rightIcon" src="../../../static/img/arrow-right.png" mode=""></image>
				</view>
			</view>
			
		</view>
		
		<!-- 更换头像的弹出框 -->
		<uni-popup :show="showPopup" type="bottom"  @change="change">
			<view class="bg-edf0f2 width-750">
				<!-- 拍照 -->
				<view class="takePhoto" @click="takePhoto">
					<text>拍照</text>
				</view>
				<!-- 相册 -->
				<view class="photoAlbum" @click="photoAlbum">
					<text>从相册选择</text>
				</view>
				
				<!-- 关闭弹出框 -->
				<view class="cancel" @click="closePopup">
					<text class="color-red">取消</text>
				</view>
			</view>
		</uni-popup>
		
	</view>	
</template>

<script>
	import uniPopup from "@/components/uni-popup/uni-popup.vue"
	// 获取用户信息，修改用户信息
	import {mapState,mapMutations} from 'vuex';
	// 缓存用户信息
	import service from '@/service.js';
	// 请求抽离
	import request from '@/request/request.js';
	export default {
		data() {
			return {
				name:"",//昵称
				motto:"",//签名
				account:'',//账号
				showPopup: false, //控制弹出框是否显示
				avatarUrl: "", //头像的地址
				phone:'', //手机号
				wxId:'' //微信id
			}
		},
		onShow() {
			// 接收上个页面传过来的参数
			let userInfo = this.userInfo;
			this.name = userInfo.name;
			this.motto = userInfo.motto;
			this.account = userInfo.account;
			this.avatarUrl = userInfo.avatarUrl;
			this.phone = userInfo.phone;
			this.wxId = userInfo.wxId;
		},
		onBackPress() {
			// 信息修改完毕，提交给服务器存入数据库
			request.setUserInfo((data)=>{
				if(data==1){
					console.log("已成功同步到数据库");
					let temp={
						account : this.account,
						name : this.name,
						phone : this.phone,
						motto : this.motto,
						avatarUrl : this.avatarUrl,
						wxId : this.wxId
					};
					// 将修改后的用户信息写入缓存
					service.addUser(temp);
				}else{
					console.log("同步到数据库失败");
				}
			},(err)=>{},(complete)=>{});
		},
		computed:{
			...mapState(['userInfo','serverUrl'])
		},
		methods: {
			// 存储用户信息的方法
			...mapMutations(['setInfo']),
			//去修改昵称的页面
			toChangeName(){
				uni.navigateTo({
					url: `changeName/changeName?name=${this.name}`,
					success: res => {},
					fail: () => {},
					complete: () => {}
				});
			},
			// 去修改签名的页面
			toChangeMotto(){
				uni.navigateTo({
					url: `changeMotto/changeMotto?motto=${this.motto}`,
					success: res => {},
					fail: () => {},
					complete: () => {}
				});
			},
			// 打开修改头像面板
			openPopup(){
				 this.showPopup = true;
			},
			//关闭修改头像面板
			closePopup(){
				this.showPopup = false;
			},
			//配合点击空白处关闭面板的函数
			change(e){
				if (!e.show){
					this.showPopup = false;
				}
			},
			// 长按自动复制账号
			accountCopy(){
				uni.setClipboardData({
					// data 必须是 string
					data:`${this.account}`,
					success: () => {
						console.log('复制账号成功');
					}
				})
			},
			// 拍照
			takePhoto(){
				request.chooseImg(this,'camera');
			},
			// 从相册选择
			photoAlbum(){
				request.chooseImg(this,'album');
			},
			// 保存用户头像信息到state
			saveLogo(){
				let temp = {
					avatarUrl : this.avatarUrl
				}
				this.setInfo(temp);
			}
		},
		components: {uniPopup},
	}
</script>

<style>
	/* 设置页面背景色 */
	page{
		width: 100%;
		height: 100%;
		background-color: #EDF0F2;
	}
	.avatarItem,.nameItem, .accountItem,.mottoItem{
		width: 100%;
		display: flex;
		align-items: center;
		color: #344955;
		padding-left: 20upx;
		background-color: white;
		justify-content: space-between;
		padding-right: 30upx;
	}
	/* 头像项 */
	.avatarItem{
		height: 200upx;
		
	}
	.avatar{
		width: 150upx;
		height: 150upx;
		line-height: 150upx;
		border-radius: 8upx;
	}
	/* 昵称、账号、个性签名项 */
	.nameItem, .accountItem,.mottoItem{
		height: 100upx;
		margin-top: 20upx;
	}
	
	/* 右图标 */
	.rightIcon{
		width: 30upx;
		height: 30upx;
		margin-left: 30upx;
	}
	
	
	/* 更换头像的弹出框 */
	.takePhoto, .photoAlbum, .cancel{
		background-color: #fff;
		width: 100%;
		height: 100upx;
		line-height: 100upx;
		display: flex;
		justify-content: center;
		color:#344955;
	}
	.cancel{
		margin-top: 20upx;
	}
</style>
