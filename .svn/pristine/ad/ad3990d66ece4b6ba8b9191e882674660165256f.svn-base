<template>
	<!-- 通讯录界面 -->
	<view>
		<!-- 常用联系人列表 -->

		<view class="top-contacts" v-show="lists.length>0">
			<view class="top-contacts-text">
				<span>常用联系人</span>
			</view>
			<!-- 后限制条件改为最近联系好友，消息发送时间 -->
			<view class="top-contacts-head" v-for="(friend,index) in lists" v-bind:key="index">
				<image v-show="index<4" :src="friend[1].avatarUrl" mode="" @tap="toFriendsInfo(friend[0])"></image>
			</view>
		</view>
		<!-- 姓氏查找框 -->
		<view class="username-search">
			<view v-for="(item,index) in searchWord" :key="index">
				<view class="word-search block" :ref="item" @tap="nameSearch(index)">
					{{item}}
				</view>
			</view>
		</view>
		<!-- 已经对好接口的好友列表 -->
		<view class="friends-lists">
			<view class="" v-for="(flist,index) in friendsLists" :key="index">
				<view class="nameIndex felx flex-vc">
					<text :id="searchWord[index]" v-show="showIndex(index)" class="ft-20 ">{{searchWord[index]}}</text>
				</view>
				<view class="friends-row bg-fff flex flex-vc" v-for="(friend,key) in flist" :key="key" @tap="toFriendsInfo(friend[0])">
					<view class="friends-head">
						<image :src="friend.avatarUrl"></image>
					</view>
					<view class="friends-username">
						<span>{{friend.name}}</span>
					</view>
				</view>
			</view>
		</view>


		<!-- 好友列表 -->
		<!-- <view class="friends-lists">
					<view class="friends-lists-text">
						<span>好友</span>
					</view>
					<view class="friends-row" v-for="(friend,key) in lists" :key="key" @tap="toFriendsInfo(friend[0])">
						<view class="friends-head">
							<image :src="friend[1].avatarUrl"></image>
						</view>
						<view class="friends-username">
							<span>{{friend[1].name}}</span>
						</view>
					</view>
				</view> -->

	</view>
</template>

<script>
	// 状态管理
	import {
		mapState,
		mapMutations
	} from 'vuex';
	// 缓存管理
	import service from '@/service.js';
	// 数据请求
	import request from '@/request/request.js';
	export default {
		computed: {
			...mapState(['myFriends', 'serverUrl', 'userInfo'])
		},
		mounted(){
			this.refs = this.$refs;
			console.log(this.refs)
		},
		data() {
			return {
				/*friendsLists的数据格式:[
					[],[],.....[] //一共27个数组，分别存不同字母开头的名字
				]*/
				friendsLists: [
					
				],
				lists: [
					// [
					// 	75443327,{
					// 	name:"枯藤星际",
					// 	motto:"蒸羊羔蒸熊掌蒸鹿尾烧花鸭烧雏鸡烧子鹅卤煮",
					// 	avatarUrl:"/static/img/avatar.png",
					// 	phone:18666666666,
					// 	account:75443327,
					// 	wxId:"",
					// 	}
					// ]
				],
				searchWord: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T',
					'U', 'V', 'W', 'X', 'Y', 'Z', '#'
				],
				// 用户uid
				account: '',
				refs:[]
			}
		},

		onShow() {
			// 更新好友列表
			this.lists = this.myFriends;
			// this.lists.sort((a, b) => b.name - a.name);
		},
		onLoad() {
			// 获取用户uid
			if (this.userInfo) {
				this.account = this.userInfo.account;
			}
			
			uni.request({
				url: "https://www.fastmock.site/mock/40e98c8f8497050b8b1c445c03db67b0/test/api/sortFriendsList",
				method: 'GET',
				data: {},
				success: (res) => {
					this.friendsLists = res.data.friendsLists
					//console.log(res.data.friendsLists)
				},
				fail: (err) => {
					
				},
				complete: () => {
					
				}
			})
		},
		onHide() {
			console.log("离开好友列表页面");
			service.addFriends(this.myFriends);
		},
		onTabItemTap() {
			// 点击底部按钮
			uni.startPullDownRefresh();
		},
		// 前往添加好友界面
		onNavigationBarButtonTap(e) {
			// 跳转到添加好友页面
			uni.navigateTo({
				url: '../../addressSubpackage/addFriends',
				success: res => {},
				fail: () => {},
				complete: () => {}
			});
		},
		methods: {
			...mapMutations(['deleteAllFriend', 'addFriend']),
			//前往好友资料页面
			toFriendsInfo(uid) {
				console.log(uid);
				uni.navigateTo({
					url: `../../addressSubpackage/friendsInfo/friendsInfo?uid=${uid}&isF=true`,
					success: res => {},
					fail: () => {},
					complete: () => {}
				});
			},
			// 首字母查找
			nameSearch(index) {
				//document.getElementById(item).scrollIntoView();
				// console.log(this.$refs)
				 console.log(this.refs.Z[0]);
				// this.refs.Z
				// this.refs.Z[0].scrollIntoView();
				// this.refs.Z[0].scrollTo();
			},
			//是否显示字母索引
			showIndex(index) {
				let firstWord = this.friendsLists[index].slice(0, 1);
				return firstWord != '' && firstWord != null && firstWord != undefined;
			}
		},
		// 下拉刷新
		onPullDownRefresh() {
			console.log("下拉刷新了");
			// 从服务器拉取新数据
			request.getLatestFriend((data) => {
				// 清空好友列表
				this.deleteAllFriend();
				for (let s of data) {
					// 分别获取每个好友的详细信息
					request.getUserInfo(s.f_id, (data) => {
						let tp = data;
						let dt = {
							name: tp.user_name,
							phone: tp.user_phone,
							account: tp.user_uid,
							avatarUrl: tp.user_avatar,
							motto: tp.user_motto,
							wxId: tp.user_wxid
						};
						console.log("刷新加入", dt.name);
						this.addFriend(dt);
					});
				}
			}, (err) => {
				console.log("数据请求失败");
				console.log(err);
			}, (complete) => {
				// 关闭下拉刷新动画
				setTimeout(() => {
					uni.stopPullDownRefresh();
				}, 1000);
			});
		},

	}
</script>

<style lang="less">
	// 引入预先定义好的less
	@import "~@/common/common.less";

	page {
		background-color: #EDF0F2;
	}
	a{
		text-decoration: none;
		color: black;
	}
	
	.top-contacts {
		height: 2.4*@u100;
		padding-left: 0.3*@u100;
		padding-top: 0.2*@u100;
		background-color: #FFFFFF;
	}

	.top-contacts-text {
		font-size: 0.2*@u100;
		color: @codeBorder;
		height: 0.5*@u100;
	}

	.top-contacts-head image {
		float: left;
		height: 1.5*@u100;
		width: 1.5*@u100;
		margin-right: 0.25*@u100;
	}

	.nameIndex {
		padding-left: 0.3*@u100;
	}

	.friends-lists {
		width: 7.5*@u100;
	}

	.friends-lists-text {
		font-size: 0.2*@u100;
		color: @codeBorder;
	}

	.friends-row {
		padding-left: 0.3*@u100;
		display: flex;
		width: 750upx;
		height: 120upx;
		border-bottom: 1px solid #EDF0F2;
	}

	.friends-head {
		width: 90upx;
		height: 90upx;
	}

	.friends-head image {
		width: 0.9*@u100;
		height: 0.9*@u100;
		border: 1px solid @codeBorder;
		border-radius: 0.5*@p100;
	}

	.friends-username {
		display: inline-block;
		height: @u100;
		line-height: @u100;
		font-size: 0.25*@u100;
		font-weight: bold;
		padding-left: 0.2*@u100;
	}

	.username-search {
		position: fixed;
		z-index: 1;
		height: @p100;
		right: 0.2*@u100;
		top: 2.5*@u100;
	}

	.word-search {
		width: 0.5*@u100;
		height: 0.36*@u100;
		line-height: 0.32*@u100;
		font-size: 0.24*@u100;
		text-align: center;
	}
</style>
