<template>
	<!-- 对话页面 -->
	<view>
		<scroll-view scroll-y="true" :scroll-top="scrollTop" class="conversationContent" :style="{height:scrollHeight + 'px'}">
			<view class="scroll">


				<view v-for="(item,index) in messages" :key="index">
					<view class="messageTime">
						<text>{{item.time}}</text>
					</view>
					<view v-show="item.sign==='other'" class="message friendMessage">
						<view class="messageHead" @tap="toFriendInfo">
							<image :src="item.head" mode=""></image>
						</view>
						<view class="messageContent">
							<text>{{item.content}}</text>
						</view>
					</view>
					<view v-show="item.sign==='me'" class="message myMessage">
						<view class="messageContent" style="background-color: #95ec69;">
							<text>{{item.content}}</text>
						</view>
						<view class="messageHead" @tap="toMyInfo">
							<image :src="item.head" mode=""></image>
						</view>
					</view>
				</view>
			</view>
			<!-- 获取scroll-view高度用 -->
			<!-- <view class="scrollBottom" style="height: 10upx;width: 100%;">
	</view> -->
		</scroll-view>
		<!-- 底部文字语言输入框 -->
		<view class="">
			<view class="conversationBottom" :style="'bottom: '+ bottom +'upx'">
				<!-- 语音消息按钮 -->
				<view class="voice" @tap="toStartRecord()">
					<image src="../../static/img/voice.png" mode=""></image>
				</view>
				<!-- 消息输入框 -->
				<view class="keyboardInput">
					<!-- 文字输入 -->
					<textarea :focus="txtInput" @focus="getKeyboardHight" v-model="content" auto-height="true" v-if="inputActive" type="text"
					 @tap="inputFocus" />
					<!-- 语音输入 -->
				<button v-else type="default"  @longpress="startRecord" @touchend="endRecord">按 住 说 话</button>				
			</view>
			<!-- 表情键盘按钮 -->
			<view class="faces" @tap="showFacesBox()">
				<image src="../../static/img/face.png" mode=""></image>
			</view>
			<!-- 消息发送按钮 -->
			<view class="messageSend" @tap="sendMessage()">
				<image src="../../static/img/send.png" mode=""></image>
			</view>
		</view>
		
	</view>
	<!-- 取消语音弹框 -->
	<view class="cancelVoice" v-show="pressActive">
		<view class="flex flex-jc flex-vc" style="width: 100%;height: 200upx;">
			<image src="../../static/img/cancelVoice.png" mode=""></image>
		</view>	
		<view class="flex flex-jc" style="width: 100%;height: 50upx;">
			<text>手指松开，取消发送</text>
		</view>		
	</view>
	<!-- 表情键盘 -->
	<view class="facesBox" v-show="show">
		<!-- 表情类型 -->
		<!-- <view class="type flex flex-vc" >
			<view v-for="(items,index) in faceList" :key="index" @tap="showFaces(index)">
				<view class="">{{item}}</view>
			</view>
		</view> -->
		<!-- 表情内容 -->
		<!-- <view class="facesContent">	 -->				
			<scroll-view  scroll-y="true" class="scroll-Y" style="height: 600upx; ">
				
					<!-- style="height: 600upx;" -->
					<!-- <image :src="emoji" mode=""></image> -->
					<view class="face" v-for="(item,index) in faceList" :key="index" @tap="showFaces(item)">
						{{item}}
					</view>
					<!-- <uni-list>
						<uni-list-item style="width: 100upx;height: 100upx;" v-for="(item,index) in faceList" :key="index" title="" note="">{{item}}</uni-list-item>
					</uni-list> -->
			</scroll-view>
			<!-- <scroll-view v-show="index===1" scroll-y="true" class="scroll-Y" style="height: 400upx;">
				<view id="demo1" class="scroll-view-item uni-bg-red" style="height: 600upx;">
					表情区域2
				</view>
			</scroll-view> -->
		<!-- </view> -->
	</view>
</view>
</template>

<script>
	//表情引入
	const appData = require("../../static/emojis/emoji.json");
	
	//获取录音权限相关
	const recorderManager = uni.getRecorderManager();
	const innerAudioContext = uni.createInnerAudioContext();
	
	innerAudioContext.autoplay = true;
	import uniSegmentedControl from "@/components/uni-segmented-control/uni-segmented-control.vue";
	import {mapState,mapMutations} from 'vuex';
	export default{
		components: {uniSegmentedControl},
		mounted() {
			// this.scrollHeight = this.getScrollHeight();
			// this.scrollTop = this.getScrollTop()
			var that = this;
			// var height=uni.getSystemInfoSync().statusBarHeight
			uni.getSystemInfo({
				success: function(res) {
					that.scrollHeight = res.windowHeight;//获取屏幕高度
					// console.log(that.scrollHeight)
					let info2 = uni.createSelectorQuery().select(".conversationBottom");
					// console.log(info2)
					info2.boundingClientRect(function(data){
						// console.log(data.height)
						that.scrollHeight =that.scrollHeight - data.height;//屏幕高度-底部键盘区高度
						// console.log(that.scrollHeight)
						
					}).exec();
					
					let info = uni.createSelectorQuery().select(".scroll");
					info.boundingClientRect(function(data){
						// that.scrollTop = data.height*2 - that.scrollHeight
						that.scrollTop = data.height - that.scrollHeight
						// console.log(that.scrollTop)
					}).exec();
				}
			});
		},
		data(){
			return{
				// emoji:'../../static/img/heart.png',
				scrollHeight:'',
				scrollTop:0,
				messages:[
					{
						sign:'other',
						head:'../../static/img/avatar.png',
						content:'今天晚上8点，五排组起来',
						time:'1分钟前'
					},
					{
						sign:'me',
						head:'../../static/img/avatar.png',
						content:'没问题',
						time:'刚刚'
					},
					{
						sign:'other',
						head:'../../static/img/avatar.png',
						content:'今天晚上8点，五排组起来',
						time:'1分钟前'
					},
					{
						sign:'other',
						head:'../../static/img/avatar.png',
						content:'今天晚上8点，五排组起来',
						time:'1分钟前'
					},
					{
						sign:'other',
						head:'../../static/img/avatar.png',
						content:'今天晚上8点，五排组起来',
						time:'1分钟前'
					},
					{
						sign:'other',
						head:'../../static/img/avatar.png',
						content:'今天晚上8点，五排组起来',
						time:'1分钟前'
					},
					{
						sign:'other',
						head:'../../static/img/avatar.png',
						content:'今天晚上8点，五排组起来',
						time:'1分钟前'
					},
					{
						sign:'other',
						head:'../../static/img/avatar.png',
						content:'今天晚上8点，五排组起来',
						time:'1分钟前'
					},
					{
						sign:'other',
						head:'../../static/img/avatar.png',
						content:'今天晚上8点，五排组起来',
						time:'1分钟前'
					}
					
				],
				content:'',//消息输入内容
				index:0,  //初始表情类型
				pressActive:false, //是否弹出语音取消框
				bottom:0,  //键盘高度后面获取
				show:false,  //表情键盘是否出现
				//语音输入与文字输入切换
				inputActive:false, 
				voiceActive:true,
				text: 'uni-app',
				voicePath: '',
				faceList:[  //表情类型列表
					// {
					// 	num:1,
					// 	imgUrl:'../../static/img/comment.png',
					// },
					// {
					// 	num:2,
					// 	imgUrl:'../../static/img/comment.png',
					// }
				],
				// 控制输入框聚焦
				txtInput:false,
				socketTask: null,
				// 确保websocket是打开状态
				is_open_socket: false,
				// 用户uid
				account:'',
				avatarUrl:'',
				// 好友uid
				fuid:''
			}
		},
		computed:{
			
		// 	getHeight:function(){
		// 		this.scrollTop = this.setData({scrollIntoView:'scrollBottom'})
		// 		return this.scrollTop
		// 	}
			...mapState(['tempInfo','userInfo','websocketUrl'])
			
		},
		// 关闭websocket【必须在实例销毁之前关闭,否则会是underfined错误】
		beforeDestroy() {
			this.closeSocket();
		},
		onLoad(e) {
			// 从state获取用户信息
			if(this.userInfo){
				let tp=this.userInfo;
				this.account=tp.account;
				this.avatarUrl=tp.avatarUrl;
			}
			console.log("进入会话页");
			if (e.voiceActive==1) {
				console.log("文字输入");
				this.inputActive=true;
				this.voiceActive=false;
				this.txtInput=true;
			} else{
				console.log("语音输入");
				this.inputActive=false;
				this.voiceActive=true;
			}
			
			//获取录音权限相关
			let self = this;
			recorderManager.onStop(function (res) {
			console.log('recorder stop' + JSON.stringify(res));
			self.voicePath = res.tempFilePath;
			});
			
			// 从state获取用户好友信息
			if (this.tempInfo) {
				let tp=this.tempInfo;
				let avatarUrl=tp.avatarUrl;
				let name=tp.name;
				this.fuid=tp.account;
				// 修改用户头像
				for (let i in this.messages) {
					if(this.messages[i].sign=='other'){
						this.messages[i].head=avatarUrl;
					}else if(this.messages[i].sign=='me'){
						this.messages[i].head=this.avatarUrl;
					}
				}
				// 修改导航栏
				uni.setNavigationBarTitle({
				    title: name
				});
			} else{
				
			}
			// 进入这个页面的时候创建websocket连接【整个页面随时使用】
			this.connectSocketInit();
			// 进入之后延时1s注册
			setTimeout(()=>{
				this.register(this.account, this.socketTask);
			},1000);
			for (let i in appData) {
			    this.faceList.push(appData[i].char);
					console.log(this.faceList)
			    // console.log(JSON.stringify(this.faceList));
			  };
		},
		methods:{
			getScrollHeight(){
				// return console.log('aaa')
				var that = this;
				// var height=uni.getSystemInfoSync().statusBarHeight
				uni.getSystemInfo({
					success: function(res) {
						that.scrollHeight = res.windowHeight;//获取屏幕高度
						// console.log(that.scrollHeight)
						// let info2 = uni.createSelectorQuery().select(".conversationBottom");
						// // console.log(info2)
						// info2.boundingClientRect(function(data){
						// 	// console.log(data.height)
						// 	that.scrollHeight =that.scrollHeight - data.height;//屏幕高度-底部键盘区高度
						// 	// console.log(that.scrollHeight)
							
						// }).exec();
						
						// let info = uni.createSelectorQuery().select(".scroll");
						// info.boundingClientRect(function(data){
						// 	// that.scrollTop = data.height*2 - that.scrollHeight
						// 	that.scrollTop = data.height - that.scrollHeight
						// 	// console.log(that.scrollTop)
						// }).exec();
					}
				});
				return that.scrollHeight
			},
			
			getScrollTop(){
				// return console.log('aaa')
				var that = this;
				// var height=uni.getSystemInfoSync().statusBarHeight
				uni.getSystemInfo({
					success: function(res) {
						that.scrollHeight = res.windowHeight;//获取屏幕高度
						// console.log(that.scrollHeight)
						let info2 = uni.createSelectorQuery().select(".conversationBottom");
						// console.log(info2)
						info2.boundingClientRect(function(data){
							// console.log(data.height)
							that.scrollHeight =that.scrollHeight - data.height;//屏幕高度-底部键盘区高度
							// console.log(that.scrollHeight)
							
						}).exec()
						
						let info = uni.createSelectorQuery().select(".scroll");
						info.boundingClientRect(function(data){
							// that.scrollTop = data.height*2 - that.scrollHeight
							that.scrollTop = data.height - that.scrollHeight
							// console.log(that.scrollTop)
						}).exec();
					}
				});
				return that.scrollTop
			},
			
			//表情
			// faceContent() {
			//       // this.faceShow = !this.faceShow;
			//       if (this.show == true) {
			//         for (let i in appData) {
			//           this.faceList.push(appData[i].char);
			//           // console.log(JSON.stringify(this.faceList));
			//         }
			//       } else {
			//         this.faceList = [];
			//       }
			//     },
			// 进入这个页面的时候创建websocket连接【整个页面随时使用】
			connectSocketInit() {
				// 创建一个this.socketTask对象【发送、接收、关闭socket都由这个对象操作】
				this.socketTask = uni.connectSocket({
				// 【非常重要】必须确保你的服务器是成功的,如果是手机测试千万别使用ws://127.0.0.1:9099【特别容易犯的错误】
					url: `${this.websocketUrl}`,
					success(data) {
					console.log("websocket连接成功");
					},
				});
				// 消息的发送和接收必须在正常连接打开中,才能发送或接收【否则会失败】
				this.socketTask.onOpen((res) => {
					console.log("WebSocket连接正常打开中...！");
					this.is_open_socket = true;
					// 注：只有连接正常打开中 ，才能正常成功发送消息
				// 注：只有连接正常打开中 ，才能正常收到消息
					this.socketTask.onMessage((res) => {
						console.log("收到服务器内容：" + JSON.stringify(res));
						try{
							let temp=JSON.parse(res.data);
							// 如果是发给我的
							if(this.account==temp.FID){
								let dt=temp.Data;
								dt.sign='other';
								this.messages.push(dt);
							}
						}catch(e){
							console.log(res.data);
						}
					});
				});
				// 这里仅是事件监听【如果socket关闭了会执行】
				this.socketTask.onClose(() => {
					console.log("已经被关闭了")
				});
		    },
			// 关闭websocket【离开这个页面的时候执行关闭】
			closeSocket() {
				this.socketTask.close({
					success: (res) => {
						this.is_open_socket = false;
						console.log("关闭成功", res)
					},
					fail: (err) => {
						console.log("关闭失败", err)
					},
				});
			},
			leave() {
				this.closeSocket()
			},
			// 发送数据
			sendMsg(id, friendid, Data, ws) {
				var Json = {
					'ID': id,
					'FID': friendid,
					'Data': Data
				};
				ws.send({
					data: JSON.stringify(Json),
					async success() {
						console.log("消息发送成功");
					},
					async fail() {
						console.log("消息发送失败");
					},
				});
			},
			//注册用户用的
			register(id, ws) {
				var Json = {
					'ID': id,
					'Data': "userregister"
				};
				ws.send({
					data: JSON.stringify(Json),
					async success() {
						console.log("注册成功");
					},
					async fail() {
						console.log("注册失败");
					},
				});
			},
			//获取键盘高度
			getKeyboardHight(e){
				var height = e.detail.height;
				// console.log(height);
			},
			//消息发送
			sendMessage:function(){
				let msg = this.content;
				// console.log('send')
				if(this.content!=''){
					let data={
						sign:'me',
						head:this.avatarUrl,
						content:msg,
						time:'刚刚'
					};
					this.messages.push(data);
					if (this.is_open_socket) {
						// websocket的服务器的原理是:发送一次消息,同时返回一组数据【否则服务器会进去死循环崩溃】
						this.sendMsg(this.account, this.fuid, data, this.socketTask);
					}
					this.content='';
				};
				//发送一条消息，消息始终在最底部
				this.scrollTop = this.getScrollTop();
			},
			//显示不同表情类型
			showFaces(item){
				console.log(item)
				this.content = this.content + item
			},
			//从表情键盘恢复普通键盘输入
			inputFocus(){
				if(this.bottom==600){
					this.show=false;
					this.bottom=0;
				}
			},
			//显示表情键盘
			showFacesBox(){
				if(this.show==false){
					this.voiceActive=false;
					this.inputActive=true;
					this.show=true;
					this.bottom=600;
					
				}else if(this.show==true){
					this.show=false;
					this.bottom=0;
					
				}				
			},
			//前往朋友资料页面
			toFriendInfo:function(){
				uni.navigateTo({
					url: '../addressSubpackage/friendsInfo/friendsInfo',
					success: res => {},
					fail: () => {},
					complete: () => {}
				});
			},
			//前往我的界面
			toMyInfo:function(){
				uni.navigateTo({
					url: '../mySubpackage/myInformation/myInformation',
					success: res => {},
					fail: () => {},
					complete: () => {}
				});
			},
			//点击录音图标显示开始录音按钮
			toStartRecord: function(){
				if(this.voiceActive==false){
					this.voiceActive=true;
					this.inputActive=false;
					this.show=false;
					this.bottom=0;
				}else if(this.voiceActive==true){
					this.voiceActive=false;
					this.inputActive=true
				}
			},
			// 长按开始录音，取消录音提示框出现
			startRecord() {
				this.pressActive=true;
				console.log('开始录音');			
				recorderManager.start();
			},
			// 松开手指，录音结束，取消录音提示框消失
			endRecord() {
				this.pressActive=false;
				console.log('录音结束');
				recorderManager.stop();
			}			
		}
	}
</script>

<style>
	.conversationContent{
		width: 100%;
	}
	.cancelVoice{
		width: 250upx;
		height: 250upx;
		color: #FFFFFF;
		font-size: 25upx;
		background-color: #edf0f2;
		position: fixed;
		bottom: 500upx;
		left: 250upx;
		z-index: 5;
	}
	.cancelVoice image{
		width: 200upx;
		height: 200upx;
	}
	.type{
		background-color: #FFFFFF;
	}
	.type image{
		width: 80upx;
		height: 80upx;
		border: 5upx solid #FFFFFF ;
		border-radius: 30%;
	}
	.type image:hover{
		background-color: #edf0f2;
	}
	.facesBox{
		width: 100%;
		height: 600upx; //后期与键盘高度统一
		background-color: #edf0f2;
		position: fixed;
		bottom: 0;
	}
	.face{
		width: 80upx;
		height: 100upx;
		text-align: center;
		line-height: 100upx;
		display: inline-block;
	}
	.messageTime{
		display: flex;
		justify-content: center;
		align-items: center;
		height: 60upx;
		width: 100%;
	}
	.messageTime text{
		font-size: 20upx;
		color: #4d6774;
	}
	.message{
		width: 100%;
		display: flex;
		border-bottom: 20upx solid #FFFFFF;
	}
	.friendMessage{
		justify-content: flex-start;
		padding-right: 200upx;
	}
	.myMessage{
		justify-content: flex-end;
		padding-left: 200upx;
	}
	.messageContent{
		background-color: #edf0f2;
		display: flex;
		border-radius: 10upx;
		/* max-width: 500upx; */
		height: auto;
	}
	.messageContent text{
		font-size: 25upx;
		margin: 20upx 30upx;
		
	}
	.messageHead{
		display: flex;
		justify-content: center;
		padding: 0 20upx;
	}
	.messageHead image{
		width: 80upx;
		height: 80upx;
	}
	.conversationBottom{
		position: fixed;
		/* z-index: 1; */
		width: 100%;
		/* height:100upx; */
		display: flex;
		align-items: flex-end;
		background-color: #344955;
		padding-top: 10upx;
		padding-bottom: 20upx;
	}
	.voice{
		width: 120upx;
		display: flex;
		justify-content: center;
	}
	.voice image{
		width: 60upx;
		height: 60upx;
	}
	.keyboardInput{
		background-color: #FFFFFF;
		border: 1upx solid #344955;
		width: 400upx;
		/* height: auto; */
		border-radius: 15upx;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.keyboardInput textarea{
		width: 400upx;
		min-height: 40upx;
		max-height: 150upx;
		font-size: 30upx;
		padding-top: 15upx;
		padding-bottom: 15upx;
		/* line-height: 65upx; */
	}
	.keyboardInput button{
		width: 400upx;
		height: 65upx;
		line-height: 65upx;
	}
	.faces{
		width: 110upx;
		display: flex;
		justify-content: center;
	}
	.faces image{
		width: 70upx;
		height: 70upx;
	}
	.messageSend{
		height: 70upx;
		width: 70upx;
		border: 1upx solid #344955;
		border-radius: 50%;
		background-color: #f9aa33;	
		display: flex;
		justify-content: center;
		align-items: center;
	}
	.messageSend image{		
		height: 35upx;
		width: 35upx;
	}
</style>
