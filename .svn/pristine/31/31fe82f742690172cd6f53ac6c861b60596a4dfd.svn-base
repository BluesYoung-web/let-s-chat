<template>
	<!-- 消息页面  -->
	<view>
    <scroll-view :scroll-y="isScroll" >
			<!-- 一条消息列表 -->
			<view class="message-row" :key="index" v-for="(item, index) in dataList"   @touchstart.capture="touchS" @touchmove="touchM" @touchend.capture="touchE" :data-index="index" :style="{right:item.right + 'upx'}" >
				<view class="friend-message" @tap="toConversation(item)">
					<!-- 朋友头像框 -->
					<view class="message-head relative">
						<image :src="item.imgUrl" mode="aspectFill"></image>
						<!-- 未读消息的角标 -->
						<text v-if="0 < item.msgNum && item.msgNum <= 99" class="icon">{{item.msgNum}}</text>
						<text v-if="item.msgNum > 99" class="icon">99+</text>
					</view>
					<!-- 消息内容 -->
					<view class="message-body">
						<view class="message-informatin">
							<span class="message-username">{{item.username}}</span>
							<span class="message-time">{{item.time}}</span>
						</view>
						<view class="message-content one-line-ellipsis">{{item.content}}</view>
					</view>	
				</view>
				<!-- 删除对话框（左滑出现） -->
				<view class="message-delete"    @tap="deleteMessage(index)">
					删除对话
				</view>
			</view>
	</scroll-view>  
	
	<!-- 小游戏弹出框 -->
	<uni-popup :show="showGame" @change="popupChange">
		<view class="popup bg-fff">
			<view class="game">
				<image src="../../../static/img/gobang.jpg" mode=""></image>
				<text>五子棋</text>
			</view>
			<view class="game">
				<image src="../../../static/img/add.png" mode=""></image>
				<text>添加</text>
			</view>
		</view>
	</uni-popup>
	
	</view>
</template>

<script>
	import uniPopup from "@/components/uni-popup/uni-popup.vue";
	// 使用vuex管理登录状态
	import {mapState,mapMutations} from 'vuex';
	import service from '@/service.js';
	import tools from '@/tools/tools.js';
	export default {
		components: {
			uniPopup
		},
		// 监听底部按钮点击事件
		onTabItemTap() {
			// 相当于下拉刷新
			uni.startPullDownRefresh();
		},
		mounted() {
			// 获取屏幕高度并存储
			uni.getSystemInfo({
				success: (res) => {
					this.setWindowHeght(res.windowHeight);
				}
			});
		},
		onLoad() {
			// 判断是否有账户信息
			setTimeout(()=>{
				if(! this.userInfo.account){
					uni.showModal({
						showCancel:false,
					    title: '提示',
					    content: '未登录，请登录以后再使用',
					    success: (res)=> {
					        if (res.confirm) {
					            uni.reLaunch({
					            	url:"/pages/common/login/login"
					            });
					        } 
					    }
					});
				}
			},500);
			// 显示tabBar的角标
			uni.setTabBarBadge({
			  index: 0,
			  text: this.countMsg+''
			});
		},
		onShow() {
			// 从state获取消息
			this.dataList=this.conversationMessageList;
		},
		// 显示小游戏弹出框
		onNavigationBarButtonTap(e){
			if(this.showGame==false){
				this.showGame = true;
			}else{
				this.showGame = false;
			}			
		},
		data() {
			return {
				showGame:false,
				isScroll: true,
				delBtnWidth: 160, //删除按钮宽度
				startX:'',  //手指触碰起点坐标
				dataList:[]				
			}
		},
		// 观察者
		watch: {
			// 深度观察(任何一个属性变化都会触发)
			dataList:{
				handler(newValue, oldValue) {
					// 缓存写入
					service.addConversation(this.conversationMessageList);
					console.log("观察者写入缓存");
					// 动态改变消息数
					this.changMsgNum();
				},
				deep:true
			}
		},
		methods: {
			...mapMutations(['setWindowHeght']),
			popupChange(e) {
				if (!e.show) {
					this.showGame = false;
				}
			},
			// 改变消息数
			changMsgNum(){
				const num = this.countMsg;
				if(num==0){
					uni.removeTabBarBadge({
						index:0
					});
				}else{
					uni.setTabBarBadge({
					  index: 0,
					  text: num+''
					});
				}
			},
			//前往对话界面
			toConversation(item){
				uni.navigateTo({
					url: `../../messageSubpackage/conversation?f_uid=${item.account}&name=${item.username}`,
					success: res => {},
					fail: () => {},
					complete: () => {}
				});
				item.msgNum=0;//进入对话界面以后，未读消息为零
			},
			// 删除消息			
			deleteMessage(index){
				this.dataList.splice(index,1);
				//同时减少消息tabBar右上角数字，num为零时移除
				this.changMsgNum();
			},
			// 触摸开始
			touchS(e) {
                let touch = e.touches[0];
                for (let index in this.dataList) {
                    this.dataList[index].right = 0;
                }
                this.startX = touch.clientX;
            },
			// 触摸移动
			touchM(e){
				let touch = e.touches[0];
				let item = this.dataList[e.currentTarget.dataset.index];
				let disX = this.startX - touch.clientX;
				if (disX >=20) {
				    if(disX>this.delBtnWidth){
						disX = this.delBtnWidth;
					}
				    this.isScroll = false;
				    this.dataList[e.currentTarget.dataset.index].right = disX;
				} else {
				    this.isScroll = true;
				    this.dataList[e.currentTarget.dataset.index].right = 0;
				}
			},
			// 触摸结束
			touchE(e) {
				let item = this.dataList[e.currentTarget.dataset.index];
				if (item.right >= this.delBtnWidth / 2) {
				    this.isScroll = true;
				    this.dataList[e.currentTarget.dataset.index].right = this.delBtnWidth;
				} else {
				    this.isScroll = true;
				    this.dataList[e.currentTarget.dataset.index].right = 0;
				}
			}
		},
		computed: {
			...mapState(['userInfo','is_open_socket','conversationMessageList']),
			// 计算消息条数
			countMsg(){
				let msgCount=0;
				for (let i in this.dataList) {
					msgCount+=this.dataList[i].msgNum;
				}
				msgCount= msgCount>99 ? '99+' : msgCount;
				return msgCount;
			},
		},
		// 下拉刷新
		onPullDownRefresh() {
			// 刷新页面
			this.dataList.length=this.conversationMessageList.length;
			// 关闭下拉刷新动画
			setTimeout(()=>{
				uni.stopPullDownRefresh();
			},1000);
		}
	}
</script>


<style lang="less">	
	// 引入预先定义好的less
	@import "~@/common/common.less";
	// 小游戏弹出框
	.popup{
		// height: 6*@u100;
		max-width: 5*@u100;
		padding: 0.1*@u100;
		border-radius: 50upx;
		float: left;
	}
	.game{	
		float: left;
		margin: 10upx;
		padding: 0;
		width: 1.2@u100;
		// height: 2*@u100;
		display: flex;
		flex-direction: column;
	}
	.game image{
		width: @u100;
		height: @u100;
		border-radius: 0.5*@p100;
		background-color: @codeBorder;
	}
	.game text{
		display: flex;
		justify-content: center;
		width: @u100;
		font-size: 0.2*@u100;		
	}
	.message-row{
		width: @p100;
		height: 1.5*@u100;
		position: relative;
		background-color: @colorF;
		display: flex;
	}
	.friend-message{
		width: 7.5*@u100;
		display: flex;
		/* border: 5px solid #007AFF; */
	}
	.message-delete{
		/* border: 1px solid #1AAD19; */
		width: 1.6*@u100;
		height: 1.5*@u100;
		position: absolute;
		top: 0;
		right: -1.6*@u100;
		color: @colorF;
		font-size: 0.25*@u100;
		background-color: @delMsgBtn;
		display: flex;
		align-items: center;
		justify-content: center;
	}
		
	.message-head{
		width: 0.18*@p100;
		display: flex;
		align-items: center;
		justify-content: flex-end;		
		padding-right: 0.2*@u100;
	}
	.message-head image{
		width: 0.8*@u100;
		height: 0.8*@u100;
		border: 1px solid @codeBorder;
		border-radius: 0.5*@p100;
	}
	.message-body{
		margin-top: 0.2*@u100;
		width: 0.82*@p100;
	}
	.message-username{		
		font-size: 0.28*@u100;
		font-weight: bold;
	}
	.message-time{		
		float: right;
		margin-right: 0.1*@u100;
	    color: @color93;
		font-size: 0.2*@u100;
	}
	.message-content{
		margin-top: 0.1*@u100;
		font-size: 10px;
		width: 0.68*@p100;
	}
	/* 未读消息角标 */
	.icon{
		position: absolute;
		top: 0.28*@u100;
		left: 0.84*@u100;
		font-size: 0.2*@u100;
		color: white;
		display: block;
		padding-left: 0.1*@u100;
		padding-right: 0.1*@u100;
		background-color: @iconMsg;
		border-radius: 0.4*@u100;
	}
</style>
