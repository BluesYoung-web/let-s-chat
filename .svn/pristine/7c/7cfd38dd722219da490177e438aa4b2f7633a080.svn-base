<template>
	<!-- 注册页面 -->
	<view>
		<!-- 商标logo -->
		<view class="logo width-full flex flex-jc">
			<image src="/static/img/logo.png" mode=""></image>
		</view>
		<!-- 注册的内容 -->
		<form @submit="register">
			<view v-show="showInput" class="loginContentView flex flex-ac flex-direction-column">
				<!-- 手机号输入框 -->
				<input name="phone"   placeholder-class="color-ccc" type="number" class="phoneInput flex" maxlength="11" v-model="user.phone" value=""
				 placeholder="用于登录和作为个人账号" :focus="isFocus"/>
				<!-- 验证码输入框 -->
				<view class="width-600 height-100  mg-tp20  flex flex-jsb">
					<input name="code"  placeholder-class="color-ccc" maxlength="6" class="passwordInput" type="number" placeholder="请输入验证码" 
					@focus="checkPhone" v-model="code"/>
					<!-- 获取验证码 -->
					<button class="identifying-code ft-28 color-f9aa33" :disabled="isClick" @click="getIdentifyingCode">{{time}}</button>
				</view>

				<!-- 同意来聊用户协议 -->
				<view name="" >
					<checkbox-group name="checkbox" class="width-600 mg-tp20 flex flex-vc">
						<label for="check" class="ft-30 flex flex-vc">
							<checkbox value="agreement" name="agreement" style="transform:scale(0.7); border-color: #344955;" id="check"
							/><text>阅读并接受</text>
						</label>
						<text @click="showPopup" class="ft-30 text-decoration-none color-f9aa33">《来聊用户协议》</text>
					</checkbox-group>
				</view>
				<!-- 注册按钮 -->
				<button class="registerBtn bg-344955 color-fff " form-type="submit">注册</button>

			</view>
		</form>

		<!-- 用户协议的弹出层 -->
		<uni-popup :show="popup" type="center" @change="popupChange">
			<view style="height: 1200upx;">
				<scroll-view scroll-y="true" style="height: 90%;">
					<image style="height: 3000upx;" src="/static/img/agreement.jpg" mode="scaleToFill"></image>
				</scroll-view>
				<view class="text-center mg-tp20">
					<uni-icons type="clear" color="#fff" size="30" @click="closePopup()" />
				</view>
			</view>
		</uni-popup>
	</view>
</template>

<script>
	import uniPopup from "@/components/uni-popup/uni-popup.vue"
	import uniIcons from '@/components/uni-icons/uni-icons.vue'
	// 管理账号信息
	import service from '@/service.js';
	// 登录状态管理
	import {mapState, mapMutations} from 'vuex';
	// 请求抽离
	import request from '@/request/request.js';
	// 常用方法抽离
	import tools from '@/tools/tools.js';
	// socket 抽离
	import socket from '@/socket/socket.js';
	export default {
		components: {
			uniPopup,
			uniIcons
		},
		data() {
			return {
				showInput:true,//是否显示输入框
				time: '获取验证码', //获取验证码或倒计时
				code:'',
				checkbox:false,
				currtime: 60, //倒计时
				isClick: false, //获取验证码按钮是否可用
				popup: false, //是否弹出协议面板
				isFocus:true, //是否自动聚焦
				user:{
					account:tools.generate8(), //自动生成uid
					avatarUrl:'/static/img/avatar.png',//默认头像地址
					name:'新用户',//用户昵称
					motto:'个性签名',//个性签名
					phone:'',
					wxId:''
				}
				
			}
		},
		methods: {
			...mapMutations(['setInfo']),
			// 查询数据库中是否已经存在此手机号
			checkPhone(){
				request.checkPhone(this.user.phone,(data)=>{
					if (data) {
						uni.showToast({
							title: '该手机号已注册，请重新输入',
							icon: 'none'
						});
						// 清空手机号输入框
						this.user.phone='';
					} 
				});
			},
			//获取验证码
			getIdentifyingCode() {
				tools.phoneCheck(this.user.phone,()=>{
					uni.showLoading({
						title: '加载中'
					});
					setTimeout(()=>{
						uni.hideLoading();
						// 获取验证码倒计时
						this.time = this.currtime + 's';
						this.isClick = true;
						let interval = setInterval(()=>{
							this.time = --this.currtime + 's';
							if (this.currtime <= 0) {
								clearInterval(interval);
								this.time = "重新获取";
								this.currtime = 60;
								this.isClick = false;
							}
						}, 1000)
						uni.showToast({
							icon: 'none',
							title: "获取验证码成功"
						})
					}, 1000);
				},()=>{
					uni.showToast({
						icon: 'none',
						title: '请输入有效手机号！',
					});
				});
			},
			// 注册按钮
			register(e) {
				let formMsg = e.detail.value; //表单提交的信息
				// 判断手机号是否正确
				tools.phoneCheck(this.user.phone,()=>{
					if (this.code.length != 6){
						//提示输入六位数的验证码
						uni.showToast({
							icon: "none",
							title: "请输入六位数的验证码"
						});					
				    }	// 判断是否同意用户协议
					else if (formMsg.checkbox.length == 0) {
						// 提示点击同意
						uni.showToast({
							icon: "none",
							title: "请阅读并同意用户协议"
						});
					}else{
						// 添加账号到缓存
						service.addUser(this.user);
						// 添加账号到state
						this.setInfo(this.user);
						// 连接websocket
						socket.connectSocketInit();
						// 用户注册到服务器
						request.registerUser((data)=>{
							if (data) {
								// 添加账号到本地缓存
								service.addUser(data);
								uni.showToast({
									title: '用户注册成功'
								});
								uni.reLaunch({
									url:"../../tabBar/message/message"
								});
							} else{
								uni.showToast({
									title: '用户注册失败'
								});
							}
						});
					}
				},()=>{
					uni.showToast({
						icon: 'none',
						title: '请输入有效手机号！',
					});
				});
			},
			//---------------------------弹出层------------------------
			// 展示服务协议面板
			showPopup() {
				this.popup = true;
				setTimeout(() => {
					this.showInput = false;
				},200);
			},
			//配合点击空白处关闭面板的函数
			popupChange(e) {
				if (!e.show) {
					this.popup = false;
					
					// 防止手机端输入框的placeholder层将popup弹出层覆盖,在弹出层显示时就将输入框整体的view隐藏
					setTimeout(() => {
						this.showInput = true;
					},50);
				}
			},
			// 点击关闭弹出层
			closePopup(e) {
				this.popup = false;
				setTimeout(() => {
					this.showInput = true;
				},100);
			},
		},
		computed:{
			...mapState(['serverUrl'])
		}
	}
</script>

<style lang="less">
	// 引入预先定义好的less
	@import "~@/common/common.less";
	.logo {
		padding-top: 1.5*@u100;
		padding-bottom: @u100;
	}

	.logo image {
		width: 2*@u100;
		height: 2*@u100;
	}

	.loginContentView {}

	/* 登录整体内容的view */
	.loginContentView input {
		height: @u100;
		border: @bdcolor 1px solid;
		border-radius: 6px;
		padding-left: 0.2*@u100;
		padding-left: 0.6*@u100;
		background-repeat: no-repeat;
		background-size: 0.4*@u100 0.4*@u100;
	}

	.phoneInput {
		width: 6*@u100;
		background-image: url("@{imgurl}phone.png");
		background-position: 0.18*@u100 0.3*@u100;
	}

	.passwordInput {
		width: 3.6*@u100;
		background-image: url("@{imgurl}message.png");
		background-position: 0.14*@u100 0.3*@u100;
	}

	/* 验证码的view */
	.identifying-code {
		border: 1px solid @codeBorder;
		border-radius: 6px;
		background-color: @colorF;
		width: 2.1*@u100;
		height: @u100;
		line-height: @u100;
	}

	/* 登录按钮 */
	.registerBtn {
		width: 6*@u100;
		margin-top: @u100;
	}
</style>
