// 登录状态管理
import Vue from 'vue'
import Vuex from 'vuex'
// 告诉 vue “使用” vuex
Vue.use(Vuex)

const store = new Vuex.Store({
    state: {	//全局变量定义处
        /**
         * 是否需要强制登录,是 true
         */
        forcedLogin: true,
		// 是否已经登录
        hasLogin: false,
		// PHP服务器地址
		serverUrl:'http://192.168.10.136',
		// websocket服务器地址
		websocketUrl:'ws://192.168.10.136:8848',
		//对话内容嵌入消息列表
		conversationMessageList:[
			// {
			// 	imgUrl:'/static/img/finds_01.jpg',
			// 	username:"贾榜",
			// 	time:"消息接收时间",
			// 	content:"如果暴力不是为了杀戮那将毫无意义",
			// 	right: 0,
			// 	msgNum:2,
			// 	account:11111111,
			// 	conversation:[]
			// },
		],
		// 用户信息
        userInfo: {
			name:'',
			motto:'',
			account:'',
			avatarUrl:'',
			// 是否微信登录
			wxId:'',
			phone:''
		},
		// 临时用户信息(搜索)
		tempInfo: {
			name:'',
			motto:'',
			account:'',
			avatarUrl:'',
			wxId:'',
			phone:''
		},
		// 好友列表
		myFriends:[
					// [
					// 	75443327,{
					// 	name:"枯藤星际",
					// 	motto:"蒸羊羔蒸熊掌蒸鹿尾烧花鸭烧雏鸡烧子鹅卤煮",
					// 	avatarUrl:"/static/img/avatar.png",
					// 	phone:18666666666,
					// 	account:75443327,
					// 	wxId:"",
					// 	}
					// ]
				],
		// 好友圈
		findLists:[ 
					// {
					// 	id:1,
					// 	userId: 12345678,
					// 	avatar: "/static/img/finds_01.jpg",
					// 	name: "小美",
					// 	time: 1576199585544,
					// 	showTime:new Date(1576199585544).toTimeString().substr(0, 5),
					// 	dynamicImg: "/static/img/finds_01.jpg", //发布的动态图片
					// 	likesNum: 9, //点赞数
					// 	commentsNum: 15, //评论数
					// 	likeAction: false, //是否给他点赞
					// },
				],
		// 赞我的人
		likeMe:[
			// {
				// 	name:"",
				// 	avatar:"",
				//  userId:''
			// }
		],
		// 关注我的人
		followMe:[
			// {
			// 	avatar:'',
			// 	name:'',
			// 	isFocus:0
			// }
		],
		socketTask:null,
		is_open_socket:false
    },
    mutations: {
		// 登录
        login(state) {
            state.hasLogin = true;
        },
		// 退出登录
        logout(state) {
            state.hasLogin = false;
        },
		// 设置用户信息
		setInfo(state,obj){
			for (let s in obj) {
				state.userInfo[s] = obj[s];
				console.log("存入了"+s+":"+obj[s]);
			}
		},
		// 设置搜索到的用户信息
		setInfoTemp(state,obj){
			for (let s in obj) {
				state.tempInfo[s] = obj[s];
				console.log("临时存入了"+s+":"+obj[s]);
			}
		},
		// 添加好友
		addFriend(state,obj){
			let uid=[];
			for (let i in state.myFriends) {
				let tp1=state.myFriends[i];
				if(tp1.length>0){
					for (let j in tp1) {
						uid.push(j.account);
					}
				}
			}
			// 如果好友已存在
			if (uid.includes(obj.account)) {
				console.log("已经是好友了");
			} else{
				// 对象的深拷贝!!!
				state.myFriends.push([obj.account,JSON.parse(JSON.stringify(obj))]);
			}
			console.log("添加了好友"+obj.name);
		},
		// 删除好友
		deleteFriend(state,obj){
			let uid=[];
			for (let i in state.myFriends) {
				let tp1=state.myFriends[i];
				if(tp1.length>0){
					for (let j in tp1) {
						uid.push(j.account);
					}
				}
			}
			for (let i in uid) {
				if (uid[i]==obj.account) {
					// 高阶函数删除数组项
					state.myFriends=state.myFriends.filter((item)=>item[0]!=uid[i]);
				} else{
					console.log("好友不存在");
				}
			}
			console.log("删除了好友"+obj.name);
		},
		// 从缓存列表加载好友
		addFriendFromCache(state,lists){
			// 深拷贝
			state.myFriends=JSON.parse(JSON.stringify(lists));
		},
		// 清空好友列表
		deleteAllFriend(state){
			state.myFriends.length=0;
			console.log("好友列表已清空");
		},
		// 暂存好友圈信息
		addFinds(state,lists){
			// 深拷贝
			state.findLists=JSON.parse(JSON.stringify(lists));
			console.log("好友圈信息已暂存state");
		},
		// 更新好友圈信息
		updateFinds(state,obj){
			let {id,commentsNum,likesNum}=obj;
			for (let i in state.findLists) {
				if(state.findLists[i].id==id){
					console.log(commentsNum);
					state.findLists[i].commentsNum=commentsNum;
					state.findLists[i].likesNum=likesNum;
				}
			}
		},
		// 暂存赞我的人
		addLikes(state,lists){
			// 深拷贝
			state.likeMe=JSON.parse(JSON.stringify(lists));
			console.log("赞我的人的信息已暂存");
		},
		// 暂存关注我的人
		addFocus(state,lists){
			// 深拷贝
			state.followMe=JSON.parse(JSON.stringify(lists));
			console.log("关注我的人的信息已暂存");
		},
		// 添加消息列表
		addMessageList(state,msg){
			for (let i in state.conversationMessageList) {
				// 如果已有消息项则合并
				if(state.conversationMessageList[i].account==msg.account){
					state.conversationMessageList[i].msgNum+=msg.msgNum;
					state.conversationMessageList[i].time=msg.time;
					state.conversationMessageList[i].content=msg.content;
					state.conversationMessageList[i].conversation.push(msg.conversation[0]);
					console.log(JSON.stringify(state.conversationMessageList[i].conversation));
					return;
				}
			}
			// 如果没有消息项则新增
			state.conversationMessageList.push(msg);
			console.log(JSON.stringify(state.conversationMessageList));
		},
		// 单方面发信息
		addMessageListFirst(state,msg){
		    for (let i in state.conversationMessageList) {
		    	// 如果已有消息项则合并
		    	if(state.conversationMessageList[i].account==msg.account){
		    		state.conversationMessageList[i].time=msg.time;
		    		state.conversationMessageList[i].content=msg.content;
		    		//内容push
		    		state.conversationMessageList[i].conversation.push(msg);
					return;
		    	}
		    }
			state.conversationMessageList.push(msg);
		},
		// 改变消息列表的content
		changeContent(state,obj){
			for (let i in state.conversationMessageList) {
				if(state.conversationMessageList[i].account==obj.account){
					state.conversationMessageList[i].content=obj.content;
					state.conversationMessageList[i].time=obj.time;
				}
			}
		},
		// 添加会话页面消息
		addConversationMessage(state,obj){
			for (let i in state.conversationMessageList) {
				if(state.conversationMessageList[i].account==obj.fid){
					state.conversationMessageList[i].conversation=obj.messages;
					return;
				}
			}
		},
		// 改变socket标志
		changeSocketFlag(state,if_opened){
			state.is_open_socket=if_opened;
		},
		// 存储socketTask
		addSocketTask(state,socket){
			state.socketTask=socket;
		},
		// 删除消息数
		clearMsgNum(state,fid){
			for (let i in state.messageList) {
				if(state.messageList[i].account==fid){
					state.messageList[i].msgNum=0;
				}
			}
		}
    },
	getters:{
		serverUrl:(state)=>state.serverUrl,
		userInfo:(state)=>state.userInfo,
		tempInfo:(state)=>state.tempInfo
	}
})

export default store
