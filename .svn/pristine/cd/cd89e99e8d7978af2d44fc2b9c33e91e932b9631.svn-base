<template>
	<view>
		<view class="">
			<text class="pre-86">+86 &nbsp;</text>
			<input class="width-750 height-100 bg-fff pd-lt50" 
			v-model="newPhone" type="text" 
			placeholder-class="color-ccc" placeholder="    请填写新手机号"/>
		</view>
		<view class="">
			<button type="" class="submitBtn bg-f9aa33 color-fff" @click="phoneChange">下一步</button>
		</view>
	</view>
</template>

<script>
	// 存储用户信息
	import {mapState,mapMutations} from 'vuex';
	export default {
		data() {
			return {
				newPhone:'',
				account:''
			}
		},
		onShow() {
			// 接收上个页面传过来的参数
			let userInfo = this.userInfo;
			this.account = userInfo.account;
		},
		methods: {
			// 存储用户信息的方法
			...mapMutations(['setInfo']),
			// 确认修改手机号
			phoneChange(){
				let newPhone=this.newPhone;
				let myreg = /^(0|86|17951)?(13[0-9]|15[012356789]|166|17[3678]|18[0-9]|14[57])[0-9]{8}$/;
				if (!myreg.test(newPhone)) {
					uni.showToast({
						icon: 'none',
						title: '请输入有效手机号！',
					})
				} else{
					// 信息修改完毕，提交给服务器存入数据库
					uni.request({
						url:`${this.serverUrl}?op=phoneChange` ,
						method: 'POST',
						header: {
							'content-type':'application/x-www-form-urlencoded',
						},
						data:{
							user_uid:this.account,
							user_phone:this.newPhone
						},
						success: res => {
							if(res.data==1){
								uni.showToast({
									icon: 'none',
									title: '手机号修改成功！',
								})
							}else{
								uni.showToast({
									icon: 'none',
									title: '手机号修改失败！',
								})
							}
						},
						fail: () => {},
						complete: () => {}
					});
				}
			}
		},
		computed:{
			...mapState(['userInfo','serverUrl'])
		}
	}
</script>

<style>
	page{
		background-color: #EDF0F2;
	}
	.pre-86{
		position: absolute;
		float: left;
	}
	/* 提交按钮 */
	.submitBtn{
		width: 150upx;
		margin-left: 540upx;
		margin-top: 40upx;
	}
</style>
